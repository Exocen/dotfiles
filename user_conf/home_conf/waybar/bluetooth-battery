#!/bin/bash

device=`pactl list sinks | grep -Pzo "$(pactl get-default-sink)(.|\n)*api.bluez5.address.*\"\K.*(?=\")" | tr '\0' '\n'`
percentage=`bluetoothctl info $device | grep -oP "Battery Percentage.*\(\K\d+(?=\))"`

if [ -z "${device}" ] || [ -z "${percentage}" ] ; then
    echo "{\"text\": \"\", \"tooltip\": \"\"}"
    exit 0
fi

FOLDER_PATH="/run/user/`id -u`/waybar"
mkdir -p $FOLDER_PATH
FILEPATH="$FOLDER_PATH/timestamp-$device"
e_time="Waiting for estimation"
date=`date +%s`
if [ -f "$FILEPATH" ]; then
    lines=`wc -l < $FILEPATH`
    if [ "$lines" -eq 4 ]; then
        P1=`head -n 1 $FILEPATH`
        T1=`head -n 2 $FILEPATH | tail -n 1`
        P2=`head -n 3 $FILEPATH | tail -n 1`
        T2=`tail -n 1 $FILEPATH`
        if [ "$P2" -gt "$percentage" ] && [ "$T2" -ne "$date" ] ; then
            printf "$P2\n$T2\n$percentage\n$date\n" > $FILEPATH
            e_time="`date -d@$(( (($date-$T2)/($P2-$percentage))*$percentage )) -u +%Hh%Mm%S` left"
        elif [ "$P2" -lt "$percentage" ]; then
            printf "$percentage\n$date\n" > $FILEPATH
        else
            e_time="`date -d@$(( (($T2-$T1)/($P1-$P2))*$percentage )) -u +%Hh%Mm%S` left"
        fi
    elif [ "$lines" -eq 2 ]; then
        P1=`head -n 1 $FILEPATH`
        T1=`tail -n 1 $FILEPATH`
        if [ "$P1" -gt "$percentage" ] && [ "$T1" -ne "$date" ] ; then
            printf "$P1\n$T1\n$percentage\n$date\n" > $FILEPATH
        elif [ "$P1" -lt "$percentage" ]; then
            printf "$percentage\n$date\n" > $FILEPATH
        fi
    else
        rm $FILEPATH
    fi
else
    printf "$percentage\n$date\n" > $FILEPATH
fi

if [ $percentage -ge 70 ]; then
    text="<span font='14' color='#28b463'>󱊣 </span><span>$percentage%</span>"
elif  [ $percentage -ge 35 ]; then
    text="<span font='14' color='#28b463'>󱊢 </span><span>$percentage%</span>"
elif  [ $percentage -ge 10 ]; then
    text="<span font='14' color='#FFA500'>󱊡 </span><span color='#FFA500'>$percentage%</span>"
elif  [ $percentage -lt 10 ]; then
    text="<span font='14' color='#FF0000'>󰂎 </span><span color='#FF0000'>$percentage%</span>"
fi

echo "{\"text\": \"$text\", \"tooltip\": \"$e_time\"}"
# {"text": "$text", "alt": "$alt", "tooltip": "$tooltip", "class": "$class", "percentage": $percentage }
